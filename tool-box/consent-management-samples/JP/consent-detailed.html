<!DOCTYPE html>

<head>
  <meta charset="utf-8" />
  <title>Treasure Data | 詳細な同意管理と制御</title>
</head>

<body>

  <h1>Treasure Data | 詳細な同意管理と制御</h1>

  <h2>同意管理の粒度</h2>
  <p>データを収集したり、デバイスを一意に識別することを許可または拒否できるだけでなく、データがどう利用されるかについても個別に同意を得るべきです。</p>
  <p>この例では、収集、識別、3つの利用目的について個別に同意管理を行います。なお明示的な同意が得られていない限りTD-JS-SDKは発火しません。</p>

  <h2>許可された用途の記録</h2>
  <p>計測や識別に同意を得られた場合、データの利用目的を個々のデータに付与します。</p>
  <p>利用目的についてはツールが強制できるわけではないため、データを集計・抽出・外部連携する際には、同意が得られている用途と利用目的が一致することをクエリー等で保証する必要があります。</p>

  <h2>多言語化</h2>
  <p>GDPRのように、事業者の地域ではなく利用者の国籍に基づくルールを採用している法規に沿って同意管理を行う場合、言語にかかわらず確実に同意管理を行う必要があります。</p>
  <p>このサンプルコードでは、「langResources」オブジェクトに各言語の文言を記述することで、ダイアログの中身を多言語対応させています。</p>

  <button id="btn-td-open-consent-dialogue">データ収集と利用について再設定する</button>


  <script>
    (function () {

      // このスクリプトで利用する変数を初期化
      var accStatus, td, flags = ['analytics', 'personalization', 'marketing', 'identification', 'collection'];

      // 表示する情報の各言語リソース
      var langResources = {
        'ja': {
          'title': 'サービス改善にご協力ください',
          'description': 'サービスの利便性を高める機能の実現やサービス全体の品質改善、ならびにマーケティングのためにアクセスログの収集にご協力ください。',
          'cat-purpose': 'データの利用目的',
          'cat-identification': 'デバイスの識別',
          'cat-collection': 'データの収集',
          'label-analytics': 'サービス改善のための分析',
          'label-personalization': 'サービス内でのパーソナライズ機能への応用',
          'label-marketing': '広告等のマーケティング目的のサービス外を含む利用',
          'label-identification': '上記の利用目的のためにCookie等を用いてデバイスを識別することを許可する。',
          'label-collection': '上記の利用目的のためにデータを集めることを許可する',
          'btn-save': '設定を保存',
        },
        'default': {
          'title': 'Support us to improve services',
          'description': 'We would like you to support us to collect data for improving our service quality, user experiences and marketing activities.',
          'cat-purpose': 'Purpose of Data usage',
          'cat-identification': 'Device Identification',
          'cat-collection': 'Data Collection',
          'label-analytics': 'Analyzing for services improvement.',
          'label-personalization': 'Applying to Personalization within our services.',
          'label-marketing': 'Ads and other marketing activities inside/outside of our services.',
          'label-identification': 'Allow to use Cookies and/or other mechanism for identifying devices to realize the above purposes.',
          'label-collection': 'Allow to collect data for achieving the above purposes.',
          'btn-save': 'Save Settings',
        }
      };

      // 動作を切り替えるためのCookie読み出し関数
      function readCookie(key) {
        return (('; ' + document.cookie + ';').match('; ' + key + '=([^\S;]*)') || [])[1];
      };

      // 設定値を読み出してオブジェクト化
      function restoreSettings() {
        var cookieValue = readCookie('_td_acceptance');
        var result;
        if (cookieValue) {
          try {
            result = JSON.parse(cookieValue);
          } catch (error) {
            console.log('Unable to parse the cookie.');
          }
        }
        return result;
      }

      // ブラウザの言語設定を取得する関数
      function getLang() {
        return (
          (window.navigator.languages && window.navigator.languages[0])
          || window.navigator.language
          || window.navigator.userLanguage
          || window.navigator.browserLanguage
        );
      }

      // SDKをロードして初期化する関数
      function initTrackers(options = {}) {

        // TD-JS-SDKをロード
        !function (t, e) { if (void 0 === e[t]) { e[t] = function () { e[t].clients.push(this), this._init = [Array.prototype.slice.call(arguments)] }, e[t].clients = []; for (var r = function (t) { return function () { return this["_" + t] = this["_" + t] || [], this["_" + t].push(Array.prototype.slice.call(arguments)), this } }, s = ["blockEvents", "setSignedMode", "fetchServerCookie", "unblockEvents", "setSignedMode", "setAnonymousMode", "resetUUID", "addRecord", "fetchGlobalID", "set", "trackEvent", "trackPageview", "trackClicks", "ready"], n = 0; n < s.length; n++) { var o = s[n]; e[t].prototype[o] = r(o) } var c = document.createElement("script"); c.type = "text/javascript", c.async = !0, c.src = ("https:" === document.location.protocol ? "https:" : "http:") + "//cdn.treasuredata.com/sdk/2.2/td.min.js"; var i = document.getElementsByTagName("script")[0]; i.parentNode.insertBefore(c, i) } }("Treasure", this);

        // TD-JS-SDKを初期化
        td = new Treasure({
          host: 'in.treasuredata.com',
          writeKey: '0/abcde1234567890',
          database: 'test_db',
          startInSignedMode: false
        });

      }

      // デバイス識別を有効化する関数
      function enableIdentification(options = {}) {

        // TD-JS-SDK を Signed Mode に切り替える
        td.setSignedMode();

      }

      // デバイス識別を無効化する関数
      function disableIdentification(options = {}) {

        // TD-JS-SDK を Anonymous Mode に切り替える
        td.setAnonymousMode();

      }

      // 計測を行う関数
      function track(options = {}) {

        // データ利用目的の許可/拒否をツールに記録するためのオブジェクトを作成
        var acceptedPurposes = {
          'accepted_analytics': accStatus['analytics'] ? accStatus['analytics'] : false,
          'accepted_personalization': accStatus['personalization'] ? accStatus['personalization'] : false,
          'accepted_marketing': accStatus['marketing'] ? accStatus['marketing'] : false,
        }

        // TD-JS-SDkでページビューを計測する
        td.set('$global', acceptedPurposes);
        td.trackPageview('web_log');

      }

      // ツールを発火するプロセス
      function bootTools(accStatus = {}, skipTrack = false) {
        if (accStatus['collection']) {

          // データ収集に同意していればツールを初期化
          initTrackers();

          if (accStatus['identification']) {
            // デバイス識別に同意している場合
            enableIdentification();
          } else {
            // デバイス識別に同意していない場合
            disableIdentification();
          }

          // skipTrackフラグがfalseの場合に計測を実行
          if (!skipTrack) {
            track();
          }

        } else {
          // データ収集に同意していなければ何もしない
        }

      }

      // ダイアログを構築し表示する関数
      function showDialog(forceDefault = true, callback = function () { }) {

        // ダイアログを構築
        var lang = langResources[getLang()] ? getLang() : 'default';
        var dialogDiv = document.createElement('div');
        dialogDiv.id = 'td-concent-dialogue';
        dialogDiv.style = 'position: fixed; bottom: 0; right: 0; width: 420px; margin: 0px; padding: 20px; border: 1px solid #ccc; background: #555; color: #ccc; font-size: 65%';
        dialogDiv.innerHTML = ''
          + '<h1>' + langResources[lang]['title'] + '</h1>'
          + '<p>' + langResources[lang]['description'] + '</p>'
          + '<hr />'
          + '<h2>' + langResources[lang]['cat-purpose'] + '</h2>'
          + '<input type="checkbox" name="chk-td-analytics" id="chk-td-analytics" value="1" checked />'
          + '<label for="chk-td-analytics">' + langResources[lang]['label-analytics'] + '</label>'
          + '<br />'
          + '<input type="checkbox" name="chk-td-personalization" id="chk-td-personalization" value="1" checked  />'
          + '<label for="chk-td-personalization">' + langResources[lang]['label-personalization'] + '</label>'
          + '<br />'
          + '<input type="checkbox" name="chk-td-marketing" id="chk-td-marketing" value="1" checked  />'
          + '<label for="chk-td-marketing">' + langResources[lang]['label-marketing'] + '</label>'
          + '<h2>' + langResources[lang]['cat-identification'] + '</h2>'
          + '<input type="checkbox" name="chk-td-identification" id="chk-td-identification" value="1" checked  />'
          + '<label for="chk-td-identification">' + langResources[lang]['label-identification'] + '</label>'
          + '<h2>' + langResources[lang]['cat-collection'] + '</h2>'
          + '<input type="checkbox" name="chk-td-collection" id="chk-td-collection" value="1" checked  />'
          + '<label for="chk-td-collection">' + langResources[lang]['label-collection'] + '</label>'
          + '<hr />'
          + '<button id="btn-td-save-consent">' + langResources[lang]['btn-save'] + '</button>'
          + '</form>';

        // ダイアログに関するHTMLをページに挿入する
        var scriptTag = document.currentScript || (function () {
          var tags = document.getElementsByTagName('script')
          return tags.item(tags.length - 1)
        }());
        document.getElementsByTagName('body')[0].insertBefore(dialogDiv, scriptTag);

        // 設定状態に応じてチェックボックスを更新
        if (!forceDefault) {
          for (var i = 0; i < flags.length; i++) {
            document.getElementById('chk-td-' + flags[i]).checked = accStatus[flags[i]] || false;
          }
        }

        // 「設定を保存」ボタンがクリックされたらダイアログを消し、_td_acceptance を更新する
        document.getElementById('btn-td-save-consent').addEventListener('click', function () {

          // 設定値を保存
          for (var i = 0; i < flags.length; i++) {
            if (!accStatus) {
              accStatus = {};
            }
            accStatus[flags[i]] = document.getElementById('chk-td-' + flags[i]).checked;
          }
          document.cookie = '_td_acceptance=' + JSON.stringify(accStatus) + '; path=/; Max-Age=31536000;';

          // ダイアログを閉じる
          this.parentElement.remove();

          // コールバックを発動
          callback();

        }, false);

      };

      // 設定値を復元
      accStatus = restoreSettings();

      // 同意情報が保存されているかを確認し処理を分岐
      if (accStatus) {

        // ツールを発火
        bootTools(accStatus, false);

      } else {

        // 設定が保存されていない場合はダイアログを表示
        if (!document.getElementById('td-concent-dialogue')) {
          showDialog(true, function () {
            bootTools(accStatus, false);
          });
        }

      }

      // ページ中のボタン（id属性に btn-td-open-consent-dialogue を持つ）がクリックされたらダイアログを表示
      document.getElementById('btn-td-open-consent-dialogue').addEventListener('click', function () {
        showDialog(false, function () {
          bootTools(accStatus, true);
        });
      }, false);

    }());
  </script>

</body>

</html>